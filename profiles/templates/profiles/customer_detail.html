<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <title>Customer Detail</title>
  </head>
  <body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container d-flex justify-content-between">
        <div>
          <a class="navbar-brand" href="/dashboard/">Credit Profiles</a>
          <a class="btn btn-outline-light" href="/dashboard/">Dashboard</a>
          {% if user.is_staff %}
          <a class="btn btn-success ms-2" href="/orders/new/?customer={{ customer.id }}">+ New Order</a>
          <a class="btn btn-info ms-2 text-white" href="/payments/new/?customer={{ customer.id }}">New Payment</a>
          {% endif %}
        </div>
        <div class="d-flex align-items-center gap-2">
          <a class="btn btn-sm btn-outline-light" href="/profile/">{{ user.username }}</a>
          <form method="post" action="/accounts/logout/" class="d-inline">
            {% csrf_token %}
            <input type="hidden" name="next" value="/accounts/login/" />
            <button class="btn btn-sm btn-warning" type="submit">Logout</button>
          </form>
        </div>
      </div>
    </nav>
    <div class="container py-4">
      <a href="/customers/" class="btn btn-link">← Back</a>
      <a href="/customers/{{ customer.id }}/history/" class="btn btn-outline-secondary">History</a>
      <h2 class="mb-3">{{ customer.full_name }}</h2>
      <div class="row g-3">
        <div class="col-md-4">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Customer</h5>
              <p class="mb-1"><strong>Email:</strong> {{ customer.email }}</p>
              <p class="mb-1"><strong>Phone:</strong> {{ customer.phone }}</p>
              <a class="btn btn-sm btn-secondary" href="/customers/{{ customer.id }}/credit-report.pdf">Download PDF</a>
            </div>
          </div>
        </div>
        <div class="col-md-8">
          <div class="card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Credit Profile</h5>
                {% if user.is_staff %}
                <form method="post" class="ms-3">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="recompute" />
                  <button class="btn btn-sm btn-primary">Recompute Score</button>
                </form>
                {% endif %}
              </div>
              {% if profile %}
              <p class="mt-3 mb-1"><strong>Score:</strong> {{ profile.score }}</p>
              <p class="mb-1"><strong>Risk Band:</strong> {{ profile.risk_band }}</p>
              <pre class="bg-light p-2 rounded"><code>{{ profile.features|json_script:"features" }}</code></pre>
              {% else %}
              <p class="text-muted mt-3">No profile yet.</p>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <div class="row g-3 mt-2">
        <div class="col-md-6">
          <div class="card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Recent Orders</h5>
                {% if user.is_staff %}
                <a class="btn btn-sm btn-success" href="/orders/new/?customer={{ customer.id }}">+ New Order</a>
                {% endif %}
              </div>
              <ul class="list-group list-group-flush">
                {% for o in orders %}
                <li class="list-group-item">#{{ o.id }} — {{ o.status }} — ₹{{ o.amount }} — {{ o.created_at }}</li>
                {% empty %}
                <li class="list-group-item text-muted">No orders</li>
                {% endfor %}
              </ul>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Recent Payments</h5>
                {% if user.is_staff %}
                <a class="btn btn-sm btn-success" href="/payments/new/?customer={{ customer.id }}">+ New Payment</a>
                {% endif %}
              </div>
              <ul class="list-group list-group-flush">
                {% for p in payments %}
                <li class="list-group-item">#{{ p.id }} — {{ p.method }} — {% if p.success %}OK{% else %}Failed{% endif %} — ₹{{ p.amount }}</li>
                {% empty %}
                <li class="list-group-item text-muted">No payments</li>
                {% endfor %}
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>
  </html>


