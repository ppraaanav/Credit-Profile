<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <title>Credit Profile Dashboard</title>
    <style>
      .stat-card {
        transition: transform 0.2s;
        border-left: 4px solid;
      }
      .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      }
      .stat-card.primary { border-left-color: #0d6efd; }
      .stat-card.success { border-left-color: #198754; }
      .stat-card.warning { border-left-color: #ffc107; }
      .stat-card.danger { border-left-color: #dc3545; }
      .stat-card.info { border-left-color: #0dcaf0; }
      .metric-value {
        font-size: 2rem;
        font-weight: bold;
        color: #212529;
      }
      .chart-container {
        position: relative;
        height: 300px;
      }
    </style>
  </head>
  <body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container-fluid d-flex justify-content-between">
        <div>
          <a class="navbar-brand fw-bold" href="/dashboard/"><i class="bi bi-shield-check"></i> Credit Profile System</a>
          <a class="btn btn-outline-light btn-sm ms-2" href="/customers/">Customers</a>
          <a class="btn btn-outline-light btn-sm ms-2" href="/audit-logs/"><i class="bi bi-clipboard-check"></i> Audit Logs</a>
        </div>
        <div class="d-flex align-items-center gap-2">
          <a class="btn btn-sm btn-outline-light" href="/profile/"><i class="bi bi-person-circle"></i> {{ user.username }}</a>
          <form method="post" action="/accounts/logout/" class="d-inline">
            {% csrf_token %}
            <input type="hidden" name="next" value="/accounts/login/" />
            <button class="btn btn-sm btn-warning" type="submit"><i class="bi bi-box-arrow-right"></i> Logout</button>
          </form>
        </div>
      </div>
    </nav>

    <div class="container-fluid py-4">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0"><i class="bi bi-speedometer2"></i> Dashboard Overview</h1>
        <div class="d-flex gap-2">
          <a href="/orders/new/" class="btn btn-success"><i class="bi bi-bag-plus"></i> New Order</a>
          <a href="/payments/new/" class="btn btn-info text-white"><i class="bi bi-credit-card"></i> New Payment</a>
          <a href="/customers/" class="btn btn-primary"><i class="bi bi-people"></i> View All Customers</a>
        </div>
      </div>

      <!-- Key Metrics Cards -->
      <div class="row g-3 mb-4">
        <div class="col-md-3">
          <div class="card stat-card primary h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="text-muted small mb-1">Total Credit Profiles</div>
                  <div class="metric-value">{{ total_profiles }}</div>
                </div>
                <i class="bi bi-file-earmark-person fs-1 text-primary opacity-50"></i>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card stat-card success h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="text-muted small mb-1">Average Credit Score</div>
                  <div class="metric-value">{{ avg_score }}</div>
                  <small class="text-muted">Range: {{ min_score }} - {{ max_score }}</small>
                </div>
                <i class="bi bi-graph-up-arrow fs-1 text-success opacity-50"></i>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card stat-card warning h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="text-muted small mb-1">High Risk Customers</div>
                  <div class="metric-value">{{ high_risk }}</div>
                  <small class="text-warning">{{ risk_percentage }}% of total</small>
                </div>
                <i class="bi bi-exclamation-triangle fs-1 text-warning opacity-50"></i>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card stat-card info h-100">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="text-muted small mb-1">Total Revenue</div>
                  <div class="metric-value">â‚¹{{ total_revenue|floatformat:0 }}</div>
                  <small class="text-muted">Delivered orders</small>
                </div>
                <i class="bi bi-currency-dollar fs-1 text-info opacity-50"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Secondary Metrics -->
      <div class="row g-3 mb-4">
        <div class="col-md-2">
          <div class="card h-100 text-center">
            <div class="card-body">
              <div class="text-muted small">Total Customers</div>
              <div class="fs-4 fw-bold">{{ total_customers }}</div>
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="card h-100 text-center">
            <div class="card-body">
              <div class="text-muted small">Total Orders</div>
              <div class="fs-4 fw-bold">{{ total_orders }}</div>
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="card h-100 text-center">
            <div class="card-body">
              <div class="text-muted small">Total Payments</div>
              <div class="fs-4 fw-bold">{{ total_payments }}</div>
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="card h-100 text-center">
            <div class="card-body">
              <div class="text-muted small">Payment Success</div>
              <div class="fs-4 fw-bold text-success">{{ payment_success_rate }}%</div>
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="card h-100 text-center">
            <div class="card-body">
              <div class="text-muted small">Return Rate</div>
              <div class="fs-4 fw-bold text-warning">{{ return_rate_pct }}%</div>
            </div>
          </div>
        </div>
        <div class="col-md-2">
          <div class="card h-100 text-center">
            <div class="card-body">
              <div class="text-muted small">Recent (30d)</div>
              <div class="fs-4 fw-bold">{{ recent_orders }} orders</div>
              <small class="text-muted">{{ recent_customers }} customers</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Charts Row -->
      <div class="row g-3 mb-4">
        <div class="col-md-6">
          <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Risk Band Distribution</h5>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="bandsChart"></canvas>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
              <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Payment Methods</h5>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="paymentMethodsChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Order Status & Risk Analysis -->
      <div class="row g-3">
        <div class="col-md-6">
          <div class="card shadow-sm">
            <div class="card-header bg-warning text-dark">
              <h5 class="mb-0"><i class="bi bi-list-check"></i> Order Status Breakdown</h5>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="orderStatusChart"></canvas>
              </div>
              <div class="mt-3">
                <small class="text-muted">
                  <strong>Delivered:</strong> {{ order_statuses.Delivered }} | 
                  <strong>Returned:</strong> {{ order_statuses.Returned }} ({{ return_rate_pct }}%) | 
                  <strong>Cancelled:</strong> {{ order_statuses.Cancelled }} ({{ cancelled_rate_pct }}%)
                </small>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card shadow-sm">
            <div class="card-header bg-info text-white">
              <h5 class="mb-0"><i class="bi bi-shield-exclamation"></i> Risk Analysis</h5>
            </div>
            <div class="card-body">
              <div class="mb-3">
                <div class="d-flex justify-content-between mb-2">
                  <span>Low Risk (A-B)</span>
                  <span class="fw-bold text-success">{{ low_risk }}</span>
                </div>
                <div class="progress mb-3" style="height: 25px;">
                  <div class="progress-bar bg-success" role="progressbar" style="width: {{ low_risk_pct }}%"></div>
                </div>
              </div>
              <div class="mb-3">
                <div class="d-flex justify-content-between mb-2">
                  <span>Medium Risk (C)</span>
                  <span class="fw-bold text-warning">{{ bands.C }}</span>
                </div>
                <div class="progress mb-3" style="height: 25px;">
                  <div class="progress-bar bg-warning" role="progressbar" style="width: {{ medium_risk_pct }}%"></div>
                </div>
              </div>
              <div class="mb-3">
                <div class="d-flex justify-content-between mb-2">
                  <span>High Risk (D-E)</span>
                  <span class="fw-bold text-danger">{{ high_risk }}</span>
                </div>
                <div class="progress" style="height: 25px;">
                  <div class="progress-bar bg-danger" role="progressbar" style="width: {{ high_risk_pct }}%"></div>
                </div>
              </div>
              <div class="alert alert-warning mb-0">
                <i class="bi bi-info-circle"></i> <strong>COD Usage:</strong> {{ cod_pct }}% | 
                <strong>Failed Payments:</strong> {{ failed_payments }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Risk Bands Chart
      const bandsData = {{ bands|safe }};
      const bandsCtx = document.getElementById('bandsChart');
      new Chart(bandsCtx, {
        type: 'bar',
        data: {
          labels: Object.keys(bandsData),
          datasets: [{
            label: 'Customers',
            data: Object.values(bandsData),
            backgroundColor: [
              '#198754', '#0d6efd', '#ffc107', '#fd7e14', '#dc3545'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            title: { display: false }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });

      // Payment Methods Chart
      const paymentMethodsData = {{ payment_methods|safe }};
      const paymentCtx = document.getElementById('paymentMethodsChart');
      new Chart(paymentCtx, {
        type: 'doughnut',
        data: {
          labels: Object.keys(paymentMethodsData),
          datasets: [{
            data: Object.values(paymentMethodsData),
            backgroundColor: ['#0d6efd', '#ffc107', '#0dcaf0', '#198754']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });

      // Order Status Chart
      const orderStatusData = {{ order_statuses|safe }};
      const orderCtx = document.getElementById('orderStatusChart');
      new Chart(orderCtx, {
        type: 'pie',
        data: {
          labels: Object.keys(orderStatusData),
          datasets: [{
            data: Object.values(orderStatusData),
            backgroundColor: ['#198754', '#0dcaf0', '#0d6efd', '#dc3545', '#6c757d']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    </script>
  </body>
</html>
